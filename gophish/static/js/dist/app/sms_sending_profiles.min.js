var profiles=[];function fetchPhoneNumbers(){var e=$("#access_key_id").val(),o=$("#secret_key").val(),a=$("#region").val();e&&o&&a&&($("#phone_loading").show(),$("#sms_from").html('<option value="">Loading phone numbers...</option>'),$.ajax({url:"/api/sms/phone-numbers",method:"POST",contentType:"application/json",data:JSON.stringify({access_key_id:e,secret_key:o,region:a}),success:function(e){if($("#phone_loading").hide(),e.success&&e.phone_numbers){var o='<option value="">Select Phone Number</option>';e.phone_numbers.forEach((function(e){o+='<option value="'+e+'">'+e+"</option>"})),$("#sms_from").html(o)}else $("#sms_from").html('<option value="">Error loading phone numbers</option>'),modalError(e.message||"Failed to load phone numbers")},error:function(e){$("#phone_loading").hide(),$("#sms_from").html('<option value="">Error loading phone numbers</option>');var o="Failed to load phone numbers";e.responseJSON&&e.responseJSON.message&&(o=e.responseJSON.message),modalError(o)}}))}function save(e){var o={};$.each($("#headersTable").DataTable().rows().data(),(function(e,a){o.headers.push({key:unescapeHtml(a[0]),value:unescapeHtml(a[1])})})),o.name=$("#name").val(),o.access_key_id=$("#access_key_id").val(),o.secret_key=$("#secret_key").val(),o.region=$("#region").val(),o.sms_from=$("#sms_from").val(),-1!=e?(o.id=profiles[e].id,api.SMSId.put(o).success((function(e){successFlash("Profile edited successfully!"),load(),dismiss()})).error((function(e){modalError(e.responseJSON.message)}))):api.SMS.post(o).success((function(e){successFlash("Profile added successfully!"),load(),dismiss()})).error((function(e){modalError(e.responseJSON.message)}))}function dismiss(){$("#modal\\.flashes").empty(),$("#name").val(""),$("#access_key_id").val(""),$("#secret_key").val(""),$("#region").val("us-east-1"),$("#sms_from").val(""),$("#sms_from").html('<option value="">Select Phone Number (Enter AWS credentials first)</option>'),$("#phone_loading").hide(),$("#headersTable").dataTable().DataTable().clear().draw(),$("#modal").modal("hide")}var dismissSendTestEmailModal=function(){$("#sendTestEmailModal\\.flashes").empty(),$("#sendTestModalSubmit").html("<i class='fa fa-envelope'></i> Send")},deleteProfile=function(e){Swal.fire({title:"Are you sure?",text:"This will delete the sending profile. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+escapeHtml(profiles[e].name),confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(o,a){api.SMSId.delete(profiles[e].id).success((function(e){o()})).error((function(e){a(e.responseJSON.message)}))}))}}).then((function(e){e.value&&Swal.fire("Sending Profile Deleted!","This sending profile has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.reload()}))}))};function edit(e){headers=$("#headersTable").dataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]}),$("#modalSubmit").unbind("click").click((function(){save(e)}));var o={};-1!=e?($("#profileModalLabel").text("Edit Sending Profile"),o=profiles[e],$("#name").val(o.name),$("#access_key_id").val(o.access_key_id),$("#secret_key").val(o.secret_key),$("#region").val(o.region),o.sms_from?($("#sms_from").html('<option value="'+o.sms_from+'">'+o.sms_from+"</option>"),$("#sms_from").val(o.sms_from)):$("#sms_from").html('<option value="">Select Phone Number (Enter AWS credentials first)</option>')):($("#profileModalLabel").text("New Sending Profile"),$("#region").val("us-east-1"),$("#sms_from").html('<option value="">Select Phone Number (Enter AWS credentials first)</option>'))}function copy(e){$("#modalSubmit").unbind("click").click((function(){save(-1)}));var o;o=profiles[e],$("#name").val("Copy of "+o.name),$("#access_key_id").val(o.access_key_id),$("#secret_key").val(o.secret_key),$("#region").val(o.region),o.sms_from?($("#sms_from").html('<option value="'+o.sms_from+'">'+o.sms_from+"</option>"),$("#sms_from").val(o.sms_from)):$("#sms_from").html('<option value="">Select Phone Number (Enter AWS credentials first)</option>')}function load(){$("#profileTable").hide(),$("#emptyMessage").hide(),$("#loading").show(),api.SMS.get().success((function(e){profiles=e,$("#loading").hide(),profiles.length>0?($("#profileTable").show(),profileTable=$("#profileTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]}),profileTable.clear(),profileRows=[],$.each(profiles,(function(e,o){profileRows.push([escapeHtml(o.name),o.interface_type,moment(o.modified_date).format("MMMM Do YYYY, h:mm:ss a"),"<div class='pull-right'><span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Edit Profile' onclick='edit("+e+")'>                    <i class='fa fa-pencil'></i>                    </button></span>\t\t    <span data-toggle='modal' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Profile' onclick='copy("+e+")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn btn-danger' data-toggle='tooltip' data-placement='left' title='Delete Profile' onclick='deleteProfile("+e+")'>                    <i class='fa fa-trash-o'></i>                    </button></div>"])})),profileTable.rows.add(profileRows).draw(),$('[data-toggle="tooltip"]').tooltip()):$("#emptyMessage").show()})).error((function(){$("#loading").hide(),errorFlash("Error fetching profiles")}))}function addCustomHeader(e,o){var a=[escapeHtml(e),escapeHtml(o),'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>'],s=headers.DataTable(),t=s.column(0).data().indexOf(escapeHtml(e));t>=0?s.row(t,{order:"index"}).data(a):s.row.add(a),s.draw()}$(document).ready((function(){$(".modal").on("hidden.bs.modal",(function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)})),$(".modal").on("shown.bs.modal",(function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))})),$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy((function(e){this.$element[0]===e.target||this.$element.has(e.target).length||$(e.target).closest(".cke_dialog, .cke").length||this.$element.trigger("focus")}),this))},$(document).on("hidden.bs.modal",".modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")})),$("#modal").on("hidden.bs.modal",(function(e){dismiss()})),$("#sendTestEmailModal").on("hidden.bs.modal",(function(e){dismissSendTestEmailModal()})),$("#addCustomHeader").on("click",(function(){return headerKey=$("#headerKey").val(),headerValue=$("#headerValue").val(),""==headerKey||""==headerValue||(addCustomHeader(headerKey,headerValue),$("#headerKey").val(""),$("#headerValue").val(""),$("#headerKey").focus()),!1})),$("#headersTable").on("click","span>i.fa-trash-o",(function(){headers.DataTable().row($(this).parents("tr")).remove().draw()})),$("#access_key_id, #secret_key").on("input",(function(){clearTimeout(window.phoneNumberTimeout),window.phoneNumberTimeout=setTimeout((function(){fetchPhoneNumbers()}),1e3)})),load()}));